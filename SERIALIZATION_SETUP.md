# üîß Sitecore XM Cloud Serialization Setup Guide

## Overview
This guide provides complete setup instructions for Sitecore serialization in XM Cloud projects. Follow this guide to avoid common configuration issues and get serialization working properly.

## Problem: "Environment default was not defined" Error

If you encounter the error `Environment default was not defined. Use the login command to define it.` when running `sitecore ser pull`, this indicates missing or incorrect configuration files.

## ‚úÖ Complete Solution: Required Files & Structure

### 1. Main Configuration File - `sitecore.json` (root directory)
```json
{
  "$schema": "./.sitecore/schemas/RootConfigurationFile.schema.json",
  "modules": [
    "./serialization/*.module.json"
  ],
  "plugins": [
    "Sitecore.DevEx.Extensibility.Serialization@5.2.113",
    "Sitecore.DevEx.Extensibility.Publishing@5.2.113",
    "Sitecore.DevEx.Extensibility.Indexing@5.2.113",
    "Sitecore.DevEx.Extensibility.ResourcePackage@5.2.113",
    "Sitecore.DevEx.Extensibility.Database@5.2.113",
    "Sitecore.DevEx.Extensibility.XMCloud@1.1.120"
  ],
  "serialization": {
    "defaultMaxRelativeItemPathLength": 100,
    "defaultModuleRelativeSerializationPath": "serialization",
    "removeOrphansForRoles": true,
    "removeOrphansForUsers": true,
    "continueOnItemFailure": false,
    "excludedFields": []
  },
  "settings": {
    "telemetryEnabled": true,
    "cacheAuthenticationToken": true,
    "versionComparisonEnabled": true,
    "apiClientTimeoutInMinutes": 5
  }
}
```

### 2. Module Configuration - `serialization/content.module.json`
```json
{
  "namespace": "your-project-name",
  "items": {
    "includes": [
      {
        "name": "content",
        "path": "/sitecore/content/your-project-name",
        "allowedPushOperations": "createUpdateAndDelete"
      },
      {
        "name": "templates",
        "path": "/sitecore/templates/Project/your-project-name",
        "allowedPushOperations": "createUpdateAndDelete"
      },
      {
        "name": "media",
        "path": "/sitecore/media library/Project/your-project-name",
        "allowedPushOperations": "createUpdateAndDelete"
      },
      {
        "name": "renderings",
        "path": "/sitecore/layout/Renderings/Project/your-project-name",
        "allowedPushOperations": "createUpdateAndDelete"
      }
    ]
  }
}
```

**Important**: Replace `your-project-name` with your actual project name.

### 3. Site Configuration - `.sitecore/sites.json`
```json
[
  {
    "name": "your-project-name",
    "hostName": "*",
    "language": "en"
  }
]
```

### 4. User Authentication - `.sitecore/user.json` (auto-generated by login)
This file is created automatically when you authenticate. It should contain:
```json
{
  "endpoints": {
    "xmCloud": {
      "allowWrite": true,
      "host": "https://xmclouddeploy-api.sitecorecloud.io/",
      "authority": "https://auth.sitecorecloud.io/",
      "accessToken": "...",
      "refreshToken": "...",
      "audience": "https://api.sitecorecloud.io"
    },
    "dev": {
      "ref": "xmCloud",
      "allowWrite": true,
      "host": "https://your-environment.sitecorecloud.io/",
      "authority": "https://auth.sitecorecloud.io/",
      "audience": "https://api.sitecorecloud.io"
    },
    "default": {
      "ref": "xmCloud",
      "allowWrite": true,
      "host": "https://your-environment.sitecorecloud.io/",
      "authority": "https://auth.sitecorecloud.io/",
      "audience": "https://api.sitecorecloud.io"
    }
  },
  "$schema": "./schemas/UserConfiguration.schema.json",
  "defaultEndpoint": "default"
}
```

## üöÄ Step-by-Step Setup for New Projects

### Step 1: Install & Verify Sitecore CLI
```bash
# Check version
sitecore --version

# Install if needed
dotnet tool install -g Sitecore.CLI

# Verify plugins
sitecore plugin list
```

**Expected output**: Should show version 5.2.113+ and XMCloud plugin installed.

### Step 2: Authentication & Environment Setup
```bash
# Login with write permissions
sitecore cloud login --allow-write

# List available projects
sitecore cloud project list

# List environments for your project
sitecore cloud environment list --project-id YOUR-PROJECT-ID

# Connect to specific environment
sitecore cloud environment connect --environment-id YOUR-ENV-ID --allow-write
```

**Note**: Copy your actual project ID and environment ID from the list commands.

### Step 3: Create Required Configuration Files

1. Create `sitecore.json` in root directory (use template above)
2. Create `serialization/` directory
3. Create `serialization/content.module.json` (use template above)
4. Update `.sitecore/sites.json` (use template above)

**Important**: Update all instances of `your-project-name` with your actual project name.

### Step 4: Verify Setup
```bash
# Check if module is recognized
sitecore ser info
```

**Expected output**: Should show your module with correct paths listed.

### Step 5: Pull Content
```bash
# Use explicit environment name (most reliable)
sitecore ser pull --environment-name dev

# Or use default (if properly configured)
sitecore ser pull
```

**Expected output**: Should show items being pulled and YAML files created.

## üõ†Ô∏è Common Issues & Solutions

### Issue: `Module configuration not recognized`
**Symptoms**: `sitecore ser info` doesn't show your module
**Solution**:
- Ensure `sitecore.json` exists in root directory
- Check `modules` path points to correct location
- Verify module file exists at specified path

### Issue: `Path not included in any module configuration`
**Symptoms**: Pull runs but no items are found
**Solution**:
- Use `sitecore ser explain --path "/your/sitecore/path"` to debug
- Check that content paths in module config match actual Sitecore structure
- Verify content exists at specified paths in Sitecore Cloud

### Issue: `Authentication token expired`
**Symptoms**: `Unauthorized (401)` or `Forbidden (403)` errors
**Solution**:
- Re-run `sitecore cloud login --allow-write`
- Re-connect to environment

### Issue: `No items pulled (0 changes discovered)`
**Symptoms**: Pull completes but no YAML files created
**Solution**:
- Verify content exists at paths specified in module configuration
- Check if you have proper permissions to access the content
- Ensure environment connection is correct

### Issue: `Environment default was not defined`
**Symptoms**: Commands fail with environment error
**Solution**:
- Use explicit environment name: `--environment-name dev`
- Check `user.json` has proper `default` endpoint configuration
- Re-authenticate if needed

## üìÅ Expected Directory Structure
```
your-project/
‚îú‚îÄ‚îÄ sitecore.json                 # Main Sitecore configuration
‚îú‚îÄ‚îÄ .sitecore/
‚îÇ   ‚îú‚îÄ‚îÄ user.json                 # Authentication (auto-generated)
‚îÇ   ‚îî‚îÄ‚îÄ sites.json                # Site configuration
‚îú‚îÄ‚îÄ serialization/
‚îÇ   ‚îú‚îÄ‚îÄ content.module.json       # Module configuration
‚îÇ   ‚îî‚îÄ‚îÄ serialization/            # YAML files (created by pull)
‚îÇ       ‚îú‚îÄ‚îÄ content/
‚îÇ       ‚îú‚îÄ‚îÄ templates/
‚îÇ       ‚îú‚îÄ‚îÄ media/
‚îÇ       ‚îî‚îÄ‚îÄ renderings/
‚îî‚îÄ‚îÄ src/                          # Your application code
```

## üìù Testing Your Setup

After setup, verify everything works:

1. **Check module recognition**:
   ```bash
   sitecore ser info
   ```
   Should list your module with correct paths.

2. **Test pull operation**:
   ```bash
   sitecore ser pull --environment-name dev
   ```
   Should pull items and create YAML files.

3. **Verify files created**:
   ```bash
   find serialization/serialization -name "*.yml" | wc -l
   ```
   Should show count of YAML files created.

4. **Test push operation**:
   ```bash
   sitecore ser push --environment-name dev --what-if
   ```
   Should show what would be pushed (dry run).

## üéØ Success Criteria

Your serialization setup is working correctly when:
- ‚úÖ `sitecore ser info` shows your module
- ‚úÖ `sitecore ser pull` creates YAML files
- ‚úÖ Content structure matches your Sitecore Cloud setup
- ‚úÖ Push/pull operations work without authentication errors

## üìñ Related Documentation

- [Component Creation Guide](./COMPONENT_CREATION_GUIDE.md) - How to create new components
- [Sitecore Documentation](https://doc.sitecore.com/xmc/en/developers/content-sdk/sitecore-content-sdk-for-xm-cloud.html) - Official XM Cloud docs

## üÜò Still Having Issues?

If you're still encountering problems:
1. Check the [troubleshooting section](#-common-issues--solutions) above
2. Verify all file paths and names match exactly
3. Ensure your Sitecore Cloud content structure matches your module configuration
4. Try using explicit environment names instead of relying on defaults

This setup enables full serialization workflow for component development and content management.